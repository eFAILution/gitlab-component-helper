name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - beta

permissions:
  contents: write  # For creating releases and pushing tags
  issues: write    # For commenting on issues
  pull-requests: write  # For commenting on PRs

jobs:
  validate-version:
    # Only run if CI succeeded and on beta branch
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'beta'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate version is odd minor (pre-release)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running semantic-release in dry-run mode to determine next version..."

          # Run semantic-release dry-run and capture output
          OUTPUT=$(npx semantic-release --dry-run 2>&1 || true)
          echo "$OUTPUT"

          # Extract version from output
          VERSION=$(echo "$OUTPUT" | grep -oP "The next release version is \K[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?" || echo "")

          if [ -z "$VERSION" ]; then
            echo "❌ Could not determine next version from semantic-release"
            exit 1
          fi

          echo "Next version would be: $VERSION"

          # Extract minor version (second number)
          MINOR=$(echo "$VERSION" | cut -d'.' -f2)

          echo "Minor version: $MINOR"

          # Check if minor version is odd (pre-release in VS Code)
          if [ $((MINOR % 2)) -eq 0 ]; then
            echo "❌ ERROR: Minor version $MINOR is EVEN, which VS Code treats as STABLE release"
            echo "   Beta branch must have ODD minor versions (0.7.x, 0.9.x, etc.)"
            echo "   Current would create: $VERSION"
            echo ""
            echo "To fix this, you need a commit that triggers a minor version bump."
            echo "Change your commit type from 'fix:' to 'feat:' to bump minor version."
            exit 1
          fi

          echo "✅ Minor version $MINOR is ODD - VS Code will treat this as pre-release"
          echo "   Version $VERSION is valid for beta branch"

  release:
    needs: [validate-version]
    # Run if CI succeeded AND (validation passed OR validation was skipped for main branch)
    if: github.event.workflow_run.conclusion == 'success' && (needs.validate-version.result == 'success' || needs.validate-version.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for semantic-release
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VSCE_PAT: ${{ secrets.VSCE_PAT }}  # Optional: for marketplace publishing
        run: npx semantic-release

      - name: Upload .vsix as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package
          path: '*.vsix'
          retention-days: 30
